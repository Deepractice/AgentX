name: Version

on:
  workflow_dispatch:
    inputs:
      dry_run:
        description: "Dry run - only show version calculation without consuming changesets"
        required: false
        default: false
        type: boolean

jobs:
  version:
    name: ${{ inputs.dry_run && 'Preview Version' || 'Create Release PR' }}
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GH_PAT }}

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install Dependencies
        run: bun install --frozen-lockfile

      - name: Preview Version (Dry Run)
        if: ${{ inputs.dry_run }}
        run: |
          echo "ðŸ” Dry Run Mode - Previewing version calculation"
          echo ""
          echo "=== Changeset Status ==="
          bunx changeset status --verbose
          echo ""
          echo "=== Changeset Files ==="
          find .changeset -name "*.md" ! -name "README.md" -exec echo "ðŸ“„ {}" \; -exec cat {} \; -exec echo "" \;
          echo ""
          echo "âœ… Dry run complete. No changesets were consumed."
          echo "To create the release PR, run this workflow again with dry_run unchecked."

      - name: Backup Changesets
        if: ${{ !inputs.dry_run }}
        id: backup
        run: |
          # Backup changeset files (exclude README.md and config.json)
          CHANGESET_FILES=$(find .changeset -name "*.md" ! -name "README.md" 2>/dev/null || true)

          if [ -z "$CHANGESET_FILES" ]; then
            echo "No changesets found"
            echo "content=" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Create backup content
          BACKUP=""
          for file in $CHANGESET_FILES; do
            FILENAME=$(basename "$file")
            CONTENT=$(cat "$file")
            BACKUP="${BACKUP}### ${FILENAME}

          \`\`\`markdown
          ${CONTENT}
          \`\`\`

          "
          done

          # Write to output using delimiter
          {
            echo "content<<CHANGESET_EOF"
            echo "$BACKUP"
            echo "CHANGESET_EOF"
          } >> $GITHUB_OUTPUT

      - name: Configure Git
        if: ${{ !inputs.dry_run }}
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git config --global url."https://x-access-token:${GH_TOKEN}@github.com/".insteadOf "https://github.com/"

      - name: Version Packages
        if: ${{ !inputs.dry_run }}
        run: bunx changeset version

      - name: Get Version and Create Branch
        if: ${{ !inputs.dry_run }}
        id: version
        run: |
          # Get version from apps/portagent as the main version
          VERSION=$(jq -r '.version' "apps/portagent/package.json")
          BRANCH_NAME="release/v${VERSION}"

          echo "version=v${VERSION}" >> $GITHUB_OUTPUT
          echo "branch=${BRANCH_NAME}" >> $GITHUB_OUTPUT

          # Create and switch to release branch
          git checkout -b "${BRANCH_NAME}"

      - name: Commit Version Changes
        if: ${{ !inputs.dry_run }}
        run: |
          git add .
          git commit --no-verify -m "chore: version packages for ${{ steps.version.outputs.version }}" || echo "No changes to commit"

      - name: Push Release Branch
        if: ${{ !inputs.dry_run }}
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          git push --no-verify origin ${{ steps.version.outputs.branch }}

      - name: Create Release PR
        if: ${{ !inputs.dry_run }}
        env:
          GITHUB_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          gh pr create \
            --title "chore: release ${{ steps.version.outputs.version }}" \
            --body "$(cat <<'PR_BODY_EOF'
          ## Release ${{ steps.version.outputs.version }}

          This PR was automatically created by the Version workflow.

          ### Changes

          - Check the CHANGELOG.md files for details
          - Review the version bumps in package.json files

          ### Checklist

          - [ ] Review all version bumps
          - [ ] Review all CHANGELOG.md updates
          - [ ] Verify build passes
          - [ ] Verify lint and typecheck pass

          Once approved and merged, a GitHub Release will be created automatically.

          ---

          <details>
          <summary>ðŸ“¦ Changeset Backup (for recovery if needed)</summary>

          If you need to revert this release, restore these files to `.changeset/`:

          ${{ steps.backup.outputs.content }}

          </details>
          PR_BODY_EOF
          )" \
            --base main \
            --head ${{ steps.version.outputs.branch }}
